"use strict";!function(){var e=require("http"),t=require("url"),n=require("fs"),s=require("querystring"),i=(require("crypto"),require("./templates")),r=8125,o=[],a={},c=function(){try{return JSON.parse(n.readFileSync(__dirname+"/messages.json"))}catch(e){return[{sender:"max",content:"default",ts:new Date(8675309).getTime()}]}}(),p=function(e){var t=("; "+e.headers.cookie).split("; nic=");if(2==t.length)return t.pop().split(";").shift()},u=function(e,t,n,s){e?(a[e]=(new Date).getTime(),t.end(i.index(Object.keys(a).length),"utf-8")):t.end(i.form(s),"utf-8")},d=function(){var e=[],t=(new Date).getTime()-3e5;for(var n in a)a[n]>t?e.push(n):delete a[n];return e},f=function(e,t){n.readFile(__dirname+"/"+t+".gz",function(s,i){s?n.readFile(__dirname+"/"+t,function(t,n){e.writeHead(200,{"Content-Type":"text/css"}),e.end(n,"utf-8")}):(e.writeHead(200,{"Content-Type":"text/css","content-encoding":"gzip"}),e.end(i,"utf-8"))})};e.createServer(function(e,n){var r=t.parse(e.url,!0),l=r.pathname,g=r.query,m=58e3;if(n.setTimeout(m,function(e){n.end("ended")}),"/"===l)if("POST"==e.method)e.on("data",function(e){var t=decodeURIComponent(e.toString("utf8").replace("nic=",""));n.writeHead(302,{"Content-Type":"text/html","Set-Cookie":"nic="+t,Location:"/"}),u(t,n,g)});else{n.writeHead(200,{"Content-Type":"text/html"});var h=p(e);u(h,n,g)}else if("/client.js"===l)f(n,"client.js");else if("/app.css"===l)f(n,"app.css");else if("/messages"===l)o.push([function(e){n.end(i.message(e))},p(e)]),n.writeHead(200,{"Content-Type":"text/html;"}),n.write(i.messages(c,!0),"utf-8");else if("/messages.json"===l){n.writeHead(200,{"Content-Type":"application/json;"});var S={msgs:i.messagesArray(c),people:i.ppls(d())};n.end(JSON.stringify(S),"utf-8")}else"/ping"===l?(n.writeHead(200,{"Content-Type":"text/plain;"}),n.end("pong")):"/is-new-message"===l?o.push([function(){n.end("yes")},p(e)]):"/message"===l?e.on("data",function(t){var i=s.parse(t.toString("utf8"));a[p(e)]=(new Date).getTime();var r={sender:p(e),content:i.message,ts:(new Date).getTime()};for(c.push(r),c.length>50&&c.shift();o.length;)o.pop()[0](r);g.ajax?n.writeHead(200):n.writeHead(302,{Location:"/"}),n.end("")}):(n.writeHead(404),n.end("404","utf-8"))}).listen(r),console.log("Server running on port "+r),process.stdin.resume();var l=function(){n.writeFileSync(__dirname+"/messages.json",JSON.stringify(c)),console.log(c.length+" messages saved!")};process.on("exit",function(){l()}),process.on("SIGINT",function(){process.exit(0),console.log("sigint")}),process.on("SIGTERM",function(){process.exit(0)}),process.once("SIGUSR2",function(){console.log("SIGUSR2"),l(),process.kill(process.pid,"SIGUSR2")})}();