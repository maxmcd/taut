"use strict";function onlyUnique(e,t,n){return n.indexOf(e)===t}var http=require("http"),url=require("url"),fs=require("fs"),querystring=require("querystring"),crypto=require("crypto"),templates=require("./templates"),port=8125,waiting=[],ppl={},messages=[{sender:"max",content:"default"}],getNic=function(e){var t=("; "+e.headers.cookie).split("; nic=");if(2==t.length)return t.pop().split(";").shift()},nicResponse=function(e,t,n,s){e?(ppl[e]=(new Date).getTime(),t.end(templates.index(n.noscript,Object.keys(ppl).length),"utf-8")):t.end(templates.form(s),"utf-8")},people=function(){var e=[],t=(new Date).getTime()-3e5;for(var n in ppl)ppl[n]>t?e.push(n):delete ppl[n];return e},serveAsset=function(e,t){fs.readFile("./"+t+".gz",function(n,s){n?fs.readFile("./"+t,function(t,n){e.writeHead(200,{"Content-Type":"text/css"}),e.end(n,"utf-8")}):(e.writeHead(200,{"Content-Type":"text/css","content-encoding":"gzip"}),e.end(s,"utf-8"))})};http.createServer(function(e,t){var n=url.parse(e.url,!0),s=n.pathname,i=n.query;if("/"===s)if("POST"==e.method)e.on("data",function(e){var n=decodeURIComponent(e.toString("utf8").replace("nic=",""));t.writeHead(200,{"Content-Type":"text/html","Set-Cookie":"nic="+n}),nicResponse(n,t,i)});else{t.writeHead(200,{"Content-Type":"text/html"});var r=getNic(e);nicResponse(r,t,i)}else if("/client.js"===s)serveAsset(t,"client.js");else if("/app.css"===s)serveAsset(t,"app.css");else if("/messages"===s)waiting.push([function(e){t.end("<br>"+e)},getNic(e)]),t.writeHead(200,{"Content-Type":"text/html;"}),t.write(templates.messages(messages),"utf-8");else if("/messages.json"===s){t.writeHead(200,{"Content-Type":"application/json;"});var p={msgs:templates.messagesArray(messages),people:templates.ppls(people())};t.end(JSON.stringify(p),"utf-8")}else"/is-new-message"===s?waiting.push([function(){t.end("yes")},getNic(e)]):"/message"===s?e.on("data",function(n){var s=querystring.parse(n.toString("utf8"));for(ppl[getNic(e)]=(new Date).getTime(),messages.push({sender:getNic(e),content:s.message});waiting.length;)waiting.pop()[0](n);i.ajax?t.writeHead(200):t.writeHead(302,{Location:"/"}),t.end("")}):(t.writeHead(404),t.end("404","utf-8"))}).listen(port),console.log("Server running on port "+port);