"use strict";!function(){var e=require("http"),t=require("url"),n=require("fs"),i=require("querystring"),s=(require("crypto"),require("./templates")),r=8125,a=[],o={},u=[{sender:"max",content:"default"}],c=function(e){var t=("; "+e.headers.cookie).split("; nic=");if(2==t.length)return t.pop().split(";").shift()},p=function(e,t,n,i){e?(o[e]=(new Date).getTime(),t.end(s.index(n.noscript,Object.keys(o).length),"utf-8")):t.end(s.form(i),"utf-8")},f=function(){var e=[],t=(new Date).getTime()-3e5;for(var n in o)o[n]>t?e.push(n):delete o[n];return e},d=function(e,t){n.readFile("./"+t+".gz",function(i,s){i?n.readFile("./"+t,function(t,n){e.writeHead(200,{"Content-Type":"text/css"}),e.end(n,"utf-8")}):(e.writeHead(200,{"Content-Type":"text/css","content-encoding":"gzip"}),e.end(s,"utf-8"))})};e.createServer(function(e,n){var r=t.parse(e.url,!0),l=r.pathname,g=r.query;if("/"===l)if("POST"==e.method)e.on("data",function(e){var t=decodeURIComponent(e.toString("utf8").replace("nic=",""));n.writeHead(302,{"Content-Type":"text/html","Set-Cookie":"nic="+t,Location:"/"}),p(t,n,g)});else{n.writeHead(200,{"Content-Type":"text/html"});var m=c(e);p(m,n,g)}else if("/client.js"===l)d(n,"client.js");else if("/app.css"===l)d(n,"app.css");else if("/messages"===l)a.push([function(e){n.end(s.message(e))},c(e)]),n.writeHead(200,{"Content-Type":"text/html;"}),n.write(s.messages(u,!0),"utf-8");else if("/messages.json"===l){n.writeHead(200,{"Content-Type":"application/json;"});var h={msgs:s.messagesArray(u),people:s.ppls(f())};n.end(JSON.stringify(h),"utf-8")}else"/is-new-message"===l?a.push([function(){n.end("yes")},c(e)]):"/message"===l?e.on("data",function(t){var s=i.parse(t.toString("utf8"));o[c(e)]=(new Date).getTime();var r={sender:c(e),content:s.message};for(u.push(r);a.length;)a.pop()[0](r);g.ajax?n.writeHead(200):n.writeHead(302,{Location:"/messages"}),n.end("")}):(n.writeHead(404),n.end("404","utf-8"))}).listen(r),console.log("Server running on port "+r)}();